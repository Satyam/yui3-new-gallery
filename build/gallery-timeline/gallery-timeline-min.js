YUI.add("gallery-timeline",function(e,t){"use strict";var n=e.Lang,r="region",i="start",s="end",o="left",u="url",a="container",f="loaded",l="Change",c="event",h="categories",p="top",d="center",v="right",m="px",g="strings",y="timeline",b="showDescr",w=function(){return e.ClassNameManager.getClassName.apply(this,[y].concat(e.Array(arguments)))},E=e.Node.create('<div class="'+w("bar")+'" />'),S=e.Node.create('<div class="'+w("grid")+'"/>'),x=e.Node.create('<div class="'+w("pointer")+'" />'),T='<div class="'+w("cats")+'">{categories}<p class="'+w("noCat")+'">{noCategory}</p></div>';e.Timeline=e.Base.create(y,e.Base,[],{_events:null,_mode:0,initializer:function(t){this._events=[],this.set(g,e.Intl.get("gallery-"+y)),this.after(u+l,this._load),this.after(a+l,this._render),this.after(f+l,this._render),t&&t[u]&&this._load(),t&&t[a]&&this._render(),this.publish(b,{defaultFn:this._defShowDescr})},_readBoolean:function(e,t){var n=this._readValue(e,t);return n?n.toLowerCase()==="true":null},_readDate:function(e,t){var n,r,i=this._readValue(e,t);return i?(i=i.split(" "),n=i[0].split("-"),r=i[1].split(":"),(new Date(n[0],n[1]-1,n[2],r[0],r[1],r[2])).getTime()):null},_readColor:function(e,t){var n=this._readValue(e,t),r=function(e){return("00"+parseInt(e,10).toString(16)).substr(-2)};return n?(n=n.split(","),"#"+r(n[0])+r(n[1])+r(n[2])):null},_readValue:function(e,t){var n=this._readEl(e,t);return n?n.textContent:null},_readEl:function(e,t){var n=e.getElementsByTagName(t);return n&&n.length?n[0]:null},_xmlReadCategories:function(t){var n={};e.each(t.children,function(e){n[this._readValue(e,"name")]={color:this._readColor(e,"color"),fontColor:this._readColor(e,"font_color")}},this),this.set(h,n)},_xmlReadView:function(e){var t=this._readEl(e,"displayed_period"),n=this.get(h),r=this._readEl(e,"hidden_categories").firstChild;t&&(this.set(i,this._readDate(t,i)),this.set(s,this._readDate(t,s)));while(r)n[r.textContent].hidden=!0,r=r.nextChild},_xmlReadEvents:function(t){this._events=[],e.each(t.children,function(e){this._events.push({start:this._readDate(e,i),end:this._readDate(e,s),text:this._readValue(e,"text"),fuzzy:this._readBoolean(e,"fuzzy"),locked:this._readBoolean(e,"locked"),endsToday:this._readBoolean(e,"ends_today"),category:this._readValue(e,"category"),description:this._readValue(e,"description"),icon:this._readValue(e,"icon")})},this)},load:function(e){return this.set(u,e),this},_load:function(){var t=this;t.set(f,!1),e.io(t.get(u),{on:{success:function(e,n){var r=n.responseXML;t._xmlReadCategories(t._readEl(r,h)),t._xmlReadView(t._readEl(r,"view")),t._xmlReadEvents(t._readEl(r,"events")),t.set(f,!0)}}})},_getRegion:function(e){var t=e.get(r);return t.left-=this._left,t.top-=this._top,t},_resize:function(t){t=t||this.get(a);var n=this.get(i),r=this.get(s),u=this._width,f=this._height,l=u/(r-n),d=this.get(h),v,y,b,S=!1,T,N,C=!1,k=this.get(g).today,L=function(t){return e.DataType.Date.format(new Date(t),{format:"%x"})};e.each(this._events,function(e){if(e.category&&d[e.category].hidden)return;v=e._bar||E.cloneNode(),N=e._pointer,b=Math.round((e.start-n)*l),y=Math.round(((e.endsToday?Date.now():e.end)-e.start)*l);if(b+y<0||b>u){e._bar&&(e._bar.remove(!0),e._bar=null,N&&(N.remove(!0),e._pointer=N=null)),S=!0;return}e._isPoint=y===0,v.setStyles({left:b+m,width:y?y+m:"auto"}),e._bar||(e._bar=v,e.category?v.setStyles({backgroundColor:d[e.category].color,color:d[e.category].fontColor}):C=!0,v.setContent(e.text),v.set("title",e.text+": "+L(e.start)+" - "+(e.endsToday?k:L(e.end))),e.fuzzy&&v.addClass(w("fuzzy")),(e.description||e.icon)&&v.addClass(w("hasDescr")),v.setData(c,e)),v.inDoc()||(t.append(v),S=!0),e._isPoint?(T=this._getRegion(v),v.setStyle(o,T.left-T.width/2+m),N||(e._pointer=N=x.cloneNode(),N.setStyle(p,f/2+m))):N&&(N.remove(!0),e._pointer=N=null,S=!0),N&&(N.setStyle(o,b+m),N.inDoc()||t.append(N))},this),S&&this._locate(),t.one("."+w("noCat")).setStyle("display",C?"block":"none")},_locate:function(){var t,n,r,i,s=this._height/2,o=[],u=[],f,l,h=this._mode,d=0,v=0,g=function(e,r,o,u){var a;switch(h){case 0:a=u?30*o+15:-30*(o+1)-15;break;case 1:a=u?15*o+10:-15*(o+1)-10;break;case 2:a=u?5*o+10:-5*(o+1)-10}d=Math.min(d,a),v=Math.max(v,a),e.setStyle(p,s+a+m),r[o]||(r[o]=[]),r[o].push({left:n,width:t}),i=e.getData(c)._pointer,i&&i.setStyle("height",30*o+15)};this.get(a).all("div."+w("bar")).each(function(i){r=this._getRegion(i),t=r.width,n=r.left,l=i.getData(c)._isPoint,f=l?o:u,e.some(f,function(r,s){return e.some(r,function(e){return!(e.left>n+t||n>e.left+e.width)})?!1:(g(i,f,s,l),!0)},this)||g(i,f,f.length,l)},this),d=Math.max(-d,v),d>s?h<2&&(this._mode+=1,this._locate(),this.get(a).addClass(w("compact"))):d<s/3&&h&&(this._mode-=1,this._mode===0&&this.get(a).removeClass(w("compact")),this._locate())},_grid:function(){var t=this.get(i),n=this.get(s),r=this.get(a),o=this._width,u=this._height,f=n-t,l=[36e5,24,30,12,10,10,10,10],c=1,h,p,d,v,g,y,b=function(e,t,n){e=new Date(e);switch(t){case 0:return(new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours()+n,0,0)).getTime();case 1:return(new Date(e.getFullYear(),e.getMonth(),e.getDate()+n)).getTime();case 2:return(new Date(e.getFullYear(),e.getMonth()+n,1)).getTime();default:return t=Math.pow(10,t-3),(new Date(Math.floor(e.getFullYear()/t)*t+(n?t:0),0,1)).getTime()}};r.all("div."+w("grid")).remove(!0);for(h=0;h<l.length;h+=1){c*=l[h];if(o/f*c>20)break}v=b(t,h,0);while(v<n)p=b(v,h,1),y=new Date(v),d=S.cloneNode(),g=[y.getHours()],g[0]===0&&(g[1]=y.getDate(),g[1]===1&&(g[2]=y.getMonth(),g[2]===0&&(g[3]=y.getFullYear()),g[2]=e.DataType.Date.format(y,{format:"%b"}))),d.setContent(g.slice(Math.min(3,h)).join(", ")),d.setStyles({width:Math.round((p-v)/f*o)-1+m,left:Math.round((v-t)/f*o)+m,paddingTop:u/2+m,height:u/2+m}),r.append(d),v=p},render:function(e){return this.set(a,e),this},_render:function(){var t=this.get(a),i,s;if(!t||!this.get(f))return;t.addClass(w()),t.setContent(""),e.each(this._events,function(e){delete e._pointer,delete e._bar,delete e._isPoint}),i=t.get(r),this._left=i.left,this._top=i.top,this._height=i.height,this._width=i.width,t.append(e.Node.create('<div class="'+w("divider")+'"/>')),s=t.appendChild(e.Node.create(n.sub(T,this.get(g)))),e.each(this.get(h),function(t,n){t.hidden||s.append(e.Node.create('<p style="color:'+t.fontColor+";background-color:"+t.color+'">'+n+"</p>"))}),this._descr=t.appendChild(e.Node.create('<div class="'+w("descr")+'"/>')),this._grid(),this._resize(t),t.delegate("click",this._showDescr,"div."+w("bar"),this),t.delegate("hover",function(e){e.target.setStyle("zIndex",9)},function(e){e.target.setStyle("zIndex",0)},"div."+w("bar")),t.on("gesturemovestart",this._startMove,{},this),t.on("gesturemove",this._dragMove,{},this),t.on("gesturemoveend",this._dragMove,{},this),e.on("mousewheel",this._mouseWheel,this);return},_hideDescr:function(){this._descr.setStyle("display","none")},_showDescr:function(e){var t=e.target,n=t.getData(c);this.fire(b,{bar:t,event:n,callback:this.showDescr})},_defShowDescr:function(e){var t=e.bar,n=e.event;this.showDescr(t,n)},showDescr:function(e,t){var n=this._getRegion(e),r=this._descr,i,s=n.left+n.width/2,u=this._width/3;if(t.description||t.icon)r.setContent((t.icon?'<img src="data:image/png;base64,'+t.icon+'">':"")+t.description),r.setStyles({display:"block",top:0}),r.removeClass(w(o)),r.removeClass(w(d)),r.removeClass(w(v)),i=this._getRegion(r),s<u?(r.setStyle(o,Math.max(s,0)+m),r.addClass(w(o))):s<u*2?(r.setStyle(o,s-i.width/2+m),r.addClass(w(d))):(r.setStyle(o,Math.min(s,this._width-30)-i.width+m),r.addClass(w(v))),r.setStyle(p,Math.round(n.top-i.height-20)+m)},_startMove:function(e){e.halt(),this._hideDescr(),this._pageX=e.pageX,this._start=this.get(i),this._end=this.get(s)},_dragMove:function(e){var t=this._start,n=this._end,r=this._width,o=Math.round((e.pageX-this._pageX)/r*(n-t));o&&(this.set(i,t-o),e.ctrlKey?(this.set(s,n+o),this._locate()):this.set(s,n-o),this._resize(),this._grid())},_mouseWheel:function(e){if(e.target.ancestor("#"+this.get(a).get("id"),!0)){e.halt(),this._hideDescr();var t=this.get(i),n=this.get(s),r=(n-t)*.1*(e.wheelDelta>0?-1:1);this.set(i,t-r),e.ctrlKey?(this.set(s,n+r),this._locate()):this.set(s,n-r),this._resize(),this._grid()}}},{ATTRS:{categories:{validator:n.isObject,value:{}},start:{validator:n.isNumber,value:(new Date(Date.now()-2592e6)).getTime()},end:{validator:n.isNumber,value:(new Date(Date.now()+2592e6)).getTime()},container:{setter:function(t){return e.one(t)}},url:{validator:n.isString},loaded:{validator:n.isBoolean,value:!1},strings:{value:{categories:"Categories",noCategory:"-no category-",today:"today"}}}})},"@VERSION@",{requires:["node","io-base","base","event-mousewheel","event-gestures","classnamemanager","datatype","event-hover"],skinnable:!0});
