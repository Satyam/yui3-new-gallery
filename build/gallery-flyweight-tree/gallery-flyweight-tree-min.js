YUI.add("gallery-flyweight-tree",function(e,t){"use strict";var n=e.Lang,r=e.Array,i=".",s="_bypassProxy",o="contentBox",u="value",a="expanded",f="dynamicLoader",l="tabIndex",c="focused",h="_default",p=e.ClassNameManager.getClassName,d="flyweight-tree-node",v=p(d),m=function(e){return p(d,e)},g=m("content"),y=m("children"),b=m("collapsed"),w=m(a),E=m("no-children"),S=m("first-child"),x=m("last-child"),T=m("loading"),N,C;N=e.Base.create(t,e.Widget,[],{_tree:null,_pool:null,_domEvents:null,_focusedINode:null,_eventHandles:null,initializer:function(){this._pool={},this._eventHandles=[]},destructor:function(){r.each(this._pool,function(e){e.destroy()}),this._pool=null,r.each(this._eventHandles,function(e){e.detach()}),this._eventHandles=null},_loadConfig:function(t){this._tree={children:e.clone(t)},this._initNodes(this._tree)},_initNodes:function(t){var n=this,i=!!n.get(f);r.each(t.children,function(r){n._focusedINode||(n._focusedINode=r),r._parent=t,r.id=r.id||e.guid(),i&&!r.children?r.expanded=!!r.isLeaf:r.expanded=r.expanded===undefined||!!r.expanded,n._initNodes(r)})},renderUI:function(){this.get(o).setHTML(this._getHTML())},bindUI:function(){var e=this;e._eventHandles.push(e.after("focus",e._afterFocus)),e._domEvents&&r.each(e._domEvents,function(t){e._eventHandles.push(e.after(t,e._afterDomEvent,e))})},fire:function(e,t){var n,r=this;return t&&t.domEvent?(t.node=r._poolFetchFromEvent(t),n=N.superclass.fire.call(r,e,t),r._poolReturn(t.node),n):N.superclass.fire.apply(r,arguments)},expandAll:function(){this._forSomeINode(function(e){e.children&&!e.expanded&&this._poolReturn(this._poolFetch(e).set(a,!0))})},_afterDomEvent:function(e){var t=e.node;t&&t.fire(e.type.split(":")[1],{domEvent:e.domEvent})},_getTypeString:function(e){var t=e.type||h;if(!n.isString(t)){if(!n.isObject(t))throw"Node contains unknown type";t=t.NAME}return t},_poolFetch:function(e){var t,n=e._held,r=this._getTypeString(e);return n?n:(t=this._pool[r],t===undefined&&(t=this._pool[r]=[]),t.length?(n=t.pop(),n._slideTo(e),n):this._createNode(e))},_poolReturn:function(e){if(e._iNode._held)return;var t,n=this._getTypeString(e._iNode);t=this._pool[n],t&&t.push(e)},_createNode:function(t){var i,s=t.type||this.get("defaultType");n.isString(s)&&(s=e[s]);if(s){i=new s({root:this});if(i instanceof e.FlyweightTreeNode)return i._slideTo({}),r.each(e.Object.keys(i._state.data),i._addLazyAttr,i),i._root=this,i._slideTo(t),i}return null},getRoot:function(){return this._poolFetch(this._tree)},_getHTML:function(){var e="",t=this.getRoot();return t.forSomeChildren(function(t,n,r){e+=t._getHTML(n,r.length,0)}),this._poolReturn(t),e},_findINodeByElement:function(e){var t=e.ancestor(i+C.CNAME_NODE,!0).get("id"),n=null,s=function(e){return e.id===t?(n=e,!0):e.children?r.some(e.children,s):!1};return s(this._tree)?n:null},_poolFetchFromEvent:function(e){var t=this._findINodeByElement(e.domEvent.target);return t?this._poolFetch(t):null},_forSomeINode:function(e,t){t=t||this;var n=function(i,s){return r.some(i.children||[],function(r,i){return e.call(t,r,s,i)?!0:n(r,s+1)})};return n(this._tree,0)},forSomeNodes:function(e,t){t=t||this;var n=function(r,i){r.forSomeChildren(function(r,s,o){return e.call(t,r,i,s,o)===!0?!0:n(r,i+1)})};return n(this.getRoot(),1)},_focusedNodeGetter:function(){return this._poolFetch(this._focusedINode)},_focusedNodeSetter:function(t){if(!t||t instanceof e.FlyweightTreeNode){var n=t?t._iNode:this._tree.children[0];return this._focusOnINode(n),n}return e.Attribute.INVALID_VALUE},_focusOnINode:function(t){var n=this._focusedINode,r;t&&t!==n&&(r=e.one("#"+n.id+" ."+g),r.blur(),r.set(l,-1),r=e.one("#"+t.id+" ."+g),r.focus(),r.set(l,0),this._focusedINode=t)},_dynamicLoaderSetter:function(t){return!n.isFunction(t)&&t!==null?e.Attribute.INVALID_VALUE:(t&&this._forSomeINode(function(e){e.children||(e.expanded=!!e.isLeaf)}),t)}},{ATTRS:{defaultType:{value:"FlyweightTreeNode"},dynamicLoader:{value:null,setter:"_dynamicLoaderSetter"},focusedNode:{getter:"_focusedNodeGetter",setter:"_focusedNodeSetter"}}}),e.FlyweightTreeManager=N,C=e.Base.create(d,e.Base,[],{_iNode:null,_root:null,initializer:function(e){this._root=e.root},_getHTML:function(e,t,r){var i=this._root,s=this._iNode,o=this.getAttrs(),u="",a=s.template,l=s.children&&s.children.length,c=[v],h=this.constructor;while(!a)a=h.TEMPLATE,h=h.superclass.constructor;return s._rendered=!0,l?o.expanded?(s._childrenRendered=!0,this.forSomeChildren(function(e,t,n){u+=e._getHTML(t,n.length,r+1)}),c.push(w)):c.push(b):this._root.get(f)&&!s.isLeaf?c.push(b):c.push(E),e===0&&c.push(S),e===t-1&&c.push(x),o.children=u,o.cname_node=c.join(" "),o.cname_content=g,o.cname_children=y,o.tabIndex=s===i._focusedINode?0:-1,n.sub(a,o)},_slideTo:function(e){this._iNode=e,this._stateProxy=e},forSomeChildren:function(e,t){var n=this._root,i=this._iNode.children,s,o;t=t||this,i&&i.length&&r.some(i,function(r,i,u){return s=n._poolFetch(r),o=e.call(t,s,i,u),n._poolReturn(s),o})},_expandedGetter:function(){return this._iNode.expanded!==!1},_expandedSetter:function(t){var n=this,r=n._iNode,i=n._root,s=e.one("#"+r.id),o=i.get(f);r.expanded=t=!!t;if(o&&!r.isLeaf&&(!r.children||!r.children.length)){this._loadDynamic();return}r.children&&r.children.length&&(t?(r._childrenRendered||n._renderChildren(),s.replaceClass(b,w)):s.replaceClass(w,b)),s.set("aria-expanded",String(t))},_loadDynamic:function(){var t=this,n=t._root;e.one("#"+this.get("id")).replaceClass(b,T),n.get(f).call(n,t,e.bind(t._dynamicLoadReturn,t))},_dynamicLoadReturn:function(t){var n=this,r=n._iNode,i=n._root;t?(r.children=t,i._initNodes(r),n._renderChildren()):r.isLeaf=!0,e.one("#"+r.id).replaceClass(T,r.isLeaf?E:w)},_renderChildren:function(){var t="",n=this._iNode,r=this.get("depth");n._childrenRendered=!0,this.forSomeChildren(function(e,n,i){t+=e._getHTML(n,i.length,r+1)}),e.one("#"+n.id+" ."+y).setContent(t)},hold:function(){return this._iNode._held=this},release:function(){return this._iNode._held=null,this._root._poolReturn(this),this},getParent:function(){var e=this._iNode._parent;return e?this._root._poolFetch(e):null},getNextSibling:function(){var e=this._iNode._parent,t=e&&e.children||[],n=t.indexOf(this)+1;return n===0||n>t.length?null:this._root._poolFetch(t[n])},getPreviousSibling:function(){var e=this._iNode._parent,t=e&&e.children||[],n=t.indexOf(this)-1;return n<0?null:this._root._poolFetch(t[n])},focus:function(){return this._root.set(c,this)},blur:function(){return this._root.set(c,null)},toggle:function(){return this.set(a,!this.get(a))},expand:function(){return this.set(a,!0)},collapse:function(){return this.set(a,!1)},isRoot:function(){return this._root._tree===this._iNode},_getStateVal:function(e){var t=this._iNode;return this._state.get(e,s)||!t?this._state.get(e,u):t.hasOwnProperty(e)?t[e]:this._state.get(e,u)},_setStateVal:function(e,t){var n=this._iNode;this._state.get(e,s)||this._state.get(e,"initializing")||!n?this._state.add(e,u,t):n[e]=t}},{TEMPLATE:'<div id="{id}" class="{cname_node}" role="" aria-expanded="{expanded}"><div tabIndex="{tabIndex}" class="{cname_content}">{label}</div><div class="{cname_children}" role="group">{children}</div></div>',CNAME_NODE:v,CNAME_CONTENT:g,CNAME_CHILDREN:y,CNAME_COLLAPSED:b,CNAME_EXPANDED:w,CNAME_NOCHILDREN:E,CNAME_FIRSTCHILD:S,CNAME_LASTCHILD:x,CNAME_LOADING:T,ATTRS:{root:{_bypassProxy:!0,readOnly:!0,getter:function(){return this._root}},template:{validator:n.isString},label:{validator:n.isString,value:""},id:{readOnly:!0},depth:{_bypassProxy:!0,readOnly:!0,getter:function(){var e=0,t=this._iNode;while(t._parent)e+=1,t=t._parent;return e-1}},expanded:{_bypassProxy:!0,getter:"_expandedGetter",setter:"_expandedSetter"}}}),e.FlyweightTreeNode=C},"@VERSION@",{requires:["widget","base-build"],skinnable:!1});
