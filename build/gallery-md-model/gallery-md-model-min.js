YUI.add("gallery-md-model",function(e,t){"use strict";var n=e.Lang,r=e.Array,i=e.Object,s="change",o="loaded",u="error",a="saved",f="reset",l="isModified",c="isNew",h=".",p="Change",d="add",v="undo",m=function(){};e.GalleryModel=e.Base.create(t,e.Base,[],{_values:null,_loadedValues:null,_primaryKeys:null,initializer:function(e){this._values={},this._loadedValues={},this.publish(s,{defaultFn:this._defSetValue}),this.publish(o,{defaultFn:this._defDataLoaded,preventedFn:this._stoppedDataLoaded,stoppedFn:this._stoppedDataLoaded}),this.publish(a,{preventable:!1}),e=e||{},n.isObject(e.values)&&this.after("init",this._setInitialValues)},_setInitialValues:function(t){this.setValues(t.cfg.values,"init"),this._set(l,!1),this._set(c,!0),this._loadedValues=e.clone(this._values)},destroy:function(t,i){n.isFunction(t)?(i=t,t={}):t||(t={}),i=i||m;var s=this,o=function(n){n||(r.each(s.lists.concat(),function(e){e.remove(s,t)}),e.GalleryModel.superclass.destroy.call(s)),i.apply(s,arguments)};return t.remove?this.sync("delete",t,o):o(),this},getValue:function(e){return this._values[e]},getValues:function(){return e.clone(this._values)},setValue:function(e,t,r){var i=this._values[e];return i!==t&&(this._primaryKeys.indexOf(e)===-1||n.isUndefined(i))&&this.fire(s,{name:e,newVal:t,prevVal:i,src:r}),this},_defSetValue:function(e){var t=this;e.name?(t._values[e.name]=e.newVal,t._set(l,!0)):i.each(e.newVals,function(n,r){t.setValue(r,n,e.src)})},setValues:function(e,t){var n=this,r={};return i.each(e,function(e,t){r[t]=n.getValue(t)}),this.fire(s,{newVals:e,prevVals:r,src:t}),n},getChangedValues:function(){var e={},t,n=this._loadedValues;return i.each(this._values,function(r,i){t=n[i],t!==r&&(e[i]={prevVal:t,newVal:r})}),e},getPKValues:function(){var e={},t=this;return r.each(t._primaryKeys,function(n){e[n]=t._values[n]}),e},getAsHTML:function(t){var r=this.getValue(t);return e.Escape.html(n.isValue(r)?String(r):"")},getAsURL:function(e){var t=this.getValue(e),r=[];return e?encodeURIComponent(n.isValue(t)?String(t):""):(i.each(t,function(e,t){n.isValue(e)&&r.push(encodeURIComponent(t)+"="+encodeURIComponent(e))}),r.join("&"))},_defDataLoaded:function(t){var n=this;n.setValues(t.parsed,t.src),n._set(l,!1),n._set(c,!1),n._loadedValues=e.clone(n._values),t.callback.call(n,null,t.response)},_stoppedDataLoaded:function(e){e.details[0].callback.call(this,"Load event halted")},load:function(e,t){var r=this;return n.isFunction(e)?(t=e,e={}):e||(e={}),t=t||m,r.sync("read",e,function(n,i){var s={options:e,response:i,src:"load",callback:t};n?(s.error=n,r.fire(u,s),t.apply(r,arguments)):(r._values={},s.parsed=r.parse(i),r.fire(o,s))}),r},parse:function(t){if(typeof t=="string")try{return e.JSON.parse(t)}catch(n){return this.fire(u,{error:n,response:t,src:"parse"}),null}return t},save:function(t,r){var i=this;return n.isFunction(t)?(r=t,t={}):t||(t={}),r=r||m,i._validate(i.getValues(),function(n){if(n){r.call(i,n);return}i.sync(i.get(c)?"create":"update",t,function(n,s){var f={options:t,response:s,src:"save"};if(n)f.error=n,i.fire(u,f);else{f.parsed=i.parse(s),f.callback=r,i._set(l,!1),i._set(c,!1),i._loadedValues=e.clone(i._values),i.fire(a,f);if(f.parsed)return i.fire(o,f),i}r.apply(i,arguments)})}),i},reset:function(){return this._values=e.clone(this._loadedValues),this.fire(f),this},sync:function(e,t,n){(n||m).call(this)},validate:function(e,t){(t||m).call(this)},_validate:function(e,t){var r=this;r.validate(e,function(i){if(n.isValue(i)){r.fire(u,{attributes:e,error:i,src:"validate"}),t.call(r,i);return}t.call(r)})},toJSON:function(){return this.getValues()},_isModifiedGetter:function(e,t){t=t.split(h);if(t.length>1){t=t[1];var n={};return n[t]=this._values[t]!==this._loadedValues[t],n}return e},_isNewGetter:function(e,t){t=t.split(h);if(t.length>1){t=t[1];var n={};return n[t]=!this._loadedValues.hasOwnProperty(t),n}return e},_primaryKeysSetter:function(t){return this._primaryKeys&&this._primaryKeys.length?e.Attribute.INVALID_VALUE:(t=new r(t),this._primaryKeys=t,t)},_primaryKeysGetter:function(e,t){t=t.split(h);if(t.length>1){t=t[1];var n={};return n[t]=e.indexOf(t)!==-1,n}return(e||[]).concat()}},{ATTRS:{isModified:{readOnly:!0,value:!1,validator:n.isBoolean,getter:"_isModifiedGetter"},isNew:{readOnly:!0,value:!0,validator:n.isBoolean,getter:"_isNewGetter"},primaryKeys:{setter:"_primaryKeysSetter",getter:"_primaryKeysGetter",lazyAdd:!1,value:[]}}}),e.GalleryModelSimpleUndo=function(){},e.GalleryModelSimpleUndo.prototype={initializer:function(){this._lastChange={},this._addPreserve&&this._addPreserve("_lastChange"),this.after(s,this._trackChange),this.on([o,a,f],this._resetUndo)},_trackChange:function(e){e.name&&e.src!==v&&(this._lastChange[e.name]=e.prevVal)},_resetUndo:function(){this._lastChange={}},undo:function(e){var t=this;return e?t._lastChange[e]!==undefined&&(t.setValue(e,t._lastChange[e],v),delete t._lastChange[e]):(i.each(t._lastChange,function(e,n){e!==undefined&&t.setValue(n,e,v)}),t._lastChange={}),t}},e.GalleryModelChronologicalUndo=function(){},e.GalleryModelChronologicalUndo.prototype={initializer:function(){this._changes=[],this._addPreserve&&this._addPreserve("_changes"),this.after(s,this._trackChange),this.on([o,a,f],this._resetUndo)},_trackChange:function(e){e.src!==v&&this._changes.push(e.details)},_resetUndo:function(){this._changes=[]},undo:function(){var e=this._changes.pop();return e&&(e.name?this.setValue(e.name,e.prevVal,v):this.setValues(e.prevVals,v)),this._changes.length===0&&this._set(l,!1),this}};var g="index",y=function(){};y.prototype={_isYUIModelList:!0,initializer:function(){this._shelves=[],this._currentIndex=0,this._addPreserve("_values","_loadedValues","_isNew","_isModified")},_setInitialValues:function(e){this.add(e.cfg.values)},_currentIndex:0,_shelves:null,_shelve:function(e){e===undefined&&(e=this._currentIndex);var t=this,n={};r.each(t._preserve,function(e){n[e]=t[e]}),t._shelves[e]=n},_fetch:function(e){e===undefined?e=this._currentIndex:this._currentIndex=e;var t=this,i=t._shelves[e];n.isUndefined(i)?this._initNew():r.each(t._preserve,function(e){t[e]=i[e]})},_addPreserve:function(){this._preserve=(this._preserve||[]).concat(Array.prototype.slice.call(arguments))},_initNew:function(){this._values={},this._loadedValues={},this._isNew=!0,this._isModified=!1},add:function(e,t){var i=this;return n.isArray(e)?(r.each(e,function(e,n){i.add(e,t?t+n:undefined)}),i):((i.get(l)||!i.get(c))&&i._shelve(),t===undefined&&(t=i._shelves.length),i._shelves.splice(t,0,{}),i._currentIndex=t,i._initNew(),i.setValues(e,d),i)},each:function(e){var t=this;return t._shelve(),r.each(t._shelves,function(n,r){t._currentIndex=r,t._fetch(r),e.call(t,r)!==!1&&t._shelve(r)}),t},eachModified:function(e){var t=this;return t._shelve(),r.each(t._shelves,function(n,r){t._shelves[r][l]&&(t._currentIndex=r,t._fetch(r),e.call(t,r)!==!1&&t._shelve(r))}),t},saveAllModified:function(){return this.eachModified(this.save),this},_defDataLoaded:function(t){var i=this,s=i._shelves;n.isArray(t.parsed)?(s.length&&(i.get(l)||!i.get(c))&&i._shelve(),r.each(t.parsed,function(t){s.push({_values:t,_loadedValues:e.clone(t),isNew:!1,isModified:!1})}),i._fetch(),i._sort&&i._sort(),t.callback.call(i,null,t.response)):e.GalleryModel.prototype._defDataLoaded.apply(i,arguments)},size:function(){var e=0;return r.each(this._shelves,function(){e+=1}),e},empty:function(){return this._shelves=[],this._currentIndex=0,this.reset(),this},_indexSetter:function(t){return n.isNumber(t)&&t>=0&&t<this._shelves.length?(this._shelve(this._currentIndex),this._currentIndex=t=parseInt(t,10),this._fetch(t),t):e.Attribute.INVALID_VALUE},_indexGetter:function(){return this._currentIndex},_isNewGetter:function(t,n){return n.split(h).length>1?e.GalleryModel.prototype._isNewGetter.apply(this,arguments):this._isNew},_isNewSetter:function(e){return this._isNew=e},_isModifiedGetter:function(t,n){return n.split(h).length>1?e.GalleryModel.prototype._isModifiedGetter.apply(this,arguments):this._isModified},_isModifiedSetter:function(e){return this._isModified=e}},y.ATTRS={index:{value:0,setter:"_indexSetter",getter:"_indexGetter"},isNew:{setter:"_isNewSetter"},isModified:{setter:"_isModifiedSetter"}},e.GalleryModelMultiRecord=y;var b="sortField",w="sortDir",E="asc",S="desc",x=function(){};x.prototype={_compare:null,initializer:function(){this.get(b)===undefined&&this._set(b,this.get("primaryKeys")[0]),this._setCompare(),this.after([b+p,w+p],this._sort),this.after(s,this._afterChange)},_setCompare:function(){var e=this.get(b),t=this.get(w)===E?1:-1,r=n.isFunction(e)?e:function(t){return t[e]};this._compare=function(e,n){var i=r(e._values),s=r(n._values);return(i<s?-1:i>s?1:0)*t}},_sort:function(){this._setCompare(),this._shelve(),this._shelves.sort(this._compare),this._shelves.splice(this.size()),this._fetch(0)},_afterChange:function(e){var t=e.name,r=this.get(b),i,s=this._currentIndex,o=this._shelves,u;t&&e.src!==d&&(n.isFunction(r)||t===r)&&(u=o.splice(s,1)[0],i=this._findIndex(u._values),o.splice(i,0,u),this._currentIndex=i)},_findIndex:function(e){var t=this._shelves,n=0,r=t.length,i=0,s=this._compare,o={_values:e};while(n<r){i=Math.floor((r+n)/2);switch(s(o,t[i])){case 1:n=i+1;break;case-1:r=i;break;default:n=r=i}}return n},add:function(e){if(n.isArray(e))return r.each(e,this.add,this),this;var t=this._shelves,i=0;return i=this._findIndex(e),this._currentIndex=i,t.splice(i,0,{}),this._initNew(),this.setValues(e,d),this._shelve(i),this},find:function(e,t){var r=this.get(b),i,s={};return n.isFunction(r)?null:(s[r]=e,i=this._findIndex(s),this._shelves[i]._values[r]!==e?null:((t||arguments.length<2)&&this.set(g,i),i))}},x.ATTRS={sortField:{validator:function(e){return n.isString(e)||n.isFunction(e)}},sortDir:{validator:function(e){return e===S||e===E},value:E}},e.GalleryModelSortedMultiRecord=x;var T=function(){};T.prototype={add:function(e){return n.isArray(e)?(r.each(e,this.add,this),this):((this.get(l)||!this.get(c))&&this._shelve(),this._currentIndex=e[this._primaryKeys[0]],this._initNew(),this.setValues(e,d),this)},_defDataLoaded:function(t){var i=this,s=i._shelves,o=i._primaryKeys[0];if(n.isUndefined(o))return;(i.get(l)||!i.get(c))&&i._shelve(),r.each(new r(t.parsed),function(t){s[t[o]]={_values:t,_loadedValues:e.clone(t),isNew:!1,isModified:!1}}),r.some(s,function(e,t){return i._fetch(t),!0}),t.callback.call(i,null,t.response)},next:function(){(this.get(l)||!this.get(c))&&this._shelve();var e=this._shelves,t=this._currentIndex+1,n=e.length;while(t<n&&!e.hasOwnProperty(t))t+=1;return t===n?null:(this._fetch(t),t)},previous:function(){(this.get(l)||!this.get(c))&&this._shelve();var e=this._shelves,t=this._currentIndex-1;while(t>=0&&!e.hasOwnProperty(t))t-=1;return t===-1?null:(this._fetch(t),t)}},e.GalleryModelPrimaryKeyIndex=T},"@VERSION@",{requires:["base"],skinnable:!1});
